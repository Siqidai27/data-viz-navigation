<html>
	<head>
		<meta charset="utf-8">
		<title>Navigation system using d3</title>
		<!-- <link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet"> -->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/foundation-icons/3.0/foundation-icons.min.css">
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="http://d3js.org/topojson.v2.min.js"></script>
		<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script> -->
		<!-- <script src="fisheye.js"></script> -->
		<script src="scripts/d3-tip.js"></script>
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
		<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
	</head>
	<style>
		.roads {
		  fill: none;
		  stroke-linejoin: round;
		  stroke-linecap: round;
		}

		.major-highway { stroke: #525252; stroke-width: 1.5px; }
		.secondary-highway { stroke: #737373; }
		.road { stroke: #bdbdbd; }
		.beltway { stroke: #737373; }
		.ferry-route { stroke: #4393c3; stroke-width: 1.5px; }

		.d3-tip {
      line-height: 1;
      padding: 6px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      content: "\25BC";
      position: absolute;
      text-align: center;
    }

    /* Style northward tooltips specifically */
    .d3-tip.n:after {
      margin: -2px 0 0 0;
      top: 100%;
      left: 0;
    }
	</style>

	<body>
		<h1> <div class="yellow">Navigation</div> </h1>

		<div id="header">
			<input name="StartingPoint"  type="text" id="start" placeholder="Starting point&hellip;" >
			<input name="Destination" type="text" id="destination" placeholder="Destination&hellip;">
			<button id="search">Find Cities!</button>
		</div>
		<div id="changeButtons">
			<button id="driveButton">Drive</button>
			<button id="flightButton">Flight</button>
		</div>
		<div id="plot">
			<circle id="startPoint" />
		</div>

	<script>
		var width = 960,height = 600;
		var svg = d3.select("#plot").append("svg")
		    .attr("width", width).attr("height", height);

		var projection = d3.geoAlbersUsa().scale(1100).translate([width / 2, height / 2]);
		var path = d3.geoPath().projection(projection);

		svg.call(d3.zoom().scaleExtent([1/2, 16]).on("zoom", zoomed));
		function zoomed() { g.attr("transform", d3.event.transform); }
		function dragged(d) { d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y); }
		var g = svg.append("g");

		// var rawData
		var usroads
		var citiesData, citiesLocation = [];
		var startPoint, destinationPoint;
		var pinImg, arrowImg;
		var airports, flights;

		function parseCities (line) {
			line.lng = Number(line.lng);
			line.lat = Number(line.lat);
			return line;
		}

		d3.queue()
			.defer(d3.json,"data/usroads.json")
			.defer(d3.csv, "data/uscities.csv", parseCities)
			.defer(d3.csv, "data/airports.csv")
			.defer(d3.csv, "data/flights1.csv")
			.await(function(error, rawRoads, rawCities, rawAirports, rawFlights){
				if (error) throw error;
				usroads = rawRoads;
				citiesData = rawCities;
				airports = rawAirports;
				flights = rawFlights;
				showMap()
				showCities()
			});

		function showMap(){
			var usa = g.selectAll("path")
			  	.data(topojson.feature(usroads, usroads.objects.usa).features)
				.enter().append("path")
			  	.attr("d", path)
			 	.style("fill","none")
				.style("stroke","#252525")
			  	.style("stroke-width",1);

		  	var roads = g.selectAll("path")
			 	.data(topojson.feature(usroads, usroads.objects.roads).features)
				.enter().append("path")
	      		.attr("d", path)
			  	.attr("class",function(d) { return "roads " + d.properties.type.toLowerCase().split(' ').join('-'); });
		}

		// var tip = d3.tip()
	  // .attr('class', 'd3-tip')
	  // .offset([-10, 0])
	  // .html(function(d) {
	  //   return "<strong>City:</strong> <span style='color:red'>" + d.city + "</span>";
	  // });

		function showCities(){
			citiesData.forEach(function(d) {
				citiesLocation.push({"city": d.city.toLowerCase(), "location": [d.lng,d.lat], "province": d.province});
			});

			var tool_tip = d3.tip()
      .attr("class", "d3-tip")
      .offset([-8, 0])
      .html(function(d,i) { return "City: " + citiesData[i].city; });
    	svg.call(tool_tip);

			var circles = g.selectAll("circle").data(citiesLocation).enter()
			.append("circle")
			.attr("cx", function (d) { return projection(d.location)[0]; })
			.attr("cy", function (d) { return projection(d.location)[1]; })
			.attr("r", 2)
			.style("fill","#429EFF")
			.on('mouseover', tool_tip.show)
      .on('mouseout', tool_tip.hide);

			console.log("showCircles");
			startPoint = g.append("circle")
			.attr("cx", 1)
			.attr("cy", 1)
			.attr("r", 3)
			.style("fill","white");
			destinationPoint = g.append("circle").attr("id","destinationPoint")
			.attr("cx", 1)
			.attr("cy", 1)
			.attr("r", 3)
			.style("fill","white");
			pinImg = g.append('svg:image').attr('xlink:href','images/pin2.png')
			.attr('x',-1)
			.attr('y',-1)
			.attr('height', '20')
		  .attr('width', '20')
			.attr('opacity','0');
			arrowImg = g.append('svg:image').attr('xlink:href','images/downarrow.png')
			.attr('x',-1)
			.attr('y',-1)
			.attr('height', '20')
		  .attr('width', '20')
			.attr('opacity','0');
		}

	</script>

	<script>
		// init();
		d3.select("#search").on("click", focusCities);
		d3.select("#driveButton").on("click", showDrive);
		d3.select("#flightButton").on("click", showFight);

		function focusCities(){
			var string_start = d3.select("#start").property("value").toLowerCase();
			var string_destination = d3.select("#destination").property("value").toLowerCase();
			var start = -1;
			var destination = -1;
			// console.log(citiesLocation);
			citiesLocation.map(function (data,i) {
  			if (data.city == string_start) {
    			start = i;
  			}
				if (data.city == string_destination) {
    			destination = i;
  			}
			});

			drawCities(start,destination);
		}

		function drawCities(start,destination){
			if(start == -1 || destination == -1){
				console.log("enter the name of city!");
				return false;
			}

			changedPoint = startPoint.transition().duration(1000).delay(500)
			.attr("cx", function (d) { return projection(citiesLocation[start].location)[0]; })
			.attr("cy", function (d) { return projection(citiesLocation[start].location)[1]; })
			.attr("r", 5)
			.style("fill","blue");

			// arrowImg.transition().duration(1000).delay(500)
			// .attr("x", projection(citiesLocation[start].location)[0])
			// .attr("y", projection(citiesLocation[start].location)[1])
		  // .attr('height', '25')
		  // .attr('width', '25')
			// .attr("transform", "translate(-13,-25)")
			// .attr('opacity','1');

			pinImg.transition().duration(1000).delay(500)
			.attr("x", projection(citiesLocation[destination].location)[0])
			.attr("y", projection(citiesLocation[destination].location)[1])
		  .attr('height', '40')
		  .attr('width', '40')
			.attr("transform", "translate(-20,-40)")
			.attr('opacity','1');

			destinationPoint.transition().duration(1000).delay(500)
			.attr("cx", function (d) { return projection(citiesLocation[destination].location)[0]; })
			.attr("cy", function (d) { return projection(citiesLocation[destination].location)[1]; })
			.attr("r", 5)
			.style("fill","red");
		}

		function showDrive(){
			svg.append("circle")
			.attr("cx",1)
			.attr("cy",1)
			.attr("r",10)
			.style("fill","red");
		}

		function showFight(){


			// var temp_height = 120;
			// var temp_width = 80;
			var popup = svg.append("g");
			popup.append("rect")
			.attr("id","tempbg")
			.attr("x",width/2)
			.attr("y",height/2)
			.attr("height",150)
			.attr("width",270)
			.attr("rx",10)
			.attr("ry",10)
			.style("fill","#9FDBD1")
			.style("stroke","white")
			.style("stroke-width",3)
			.style("opacity",0.7);


			// changedPoint.on("mouseover", function () {
			// 	console.log("starting point!");
			// });
			// console.log("showRect!!");
		}
	</script>

	<script>

	</script>


	</body>
</html>
